{% extends "Master/MenuBghTemplate.html.twig" %} {% block head %}
{{ parent() }}
<link
  rel="stylesheet"
  href="{{
    asset('Plugins/control_permisos/Assets/DataTables/datatables.css')
  }}"
/>
{% endblock %} {% block body %}
<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12">
      {% include 'componentes/tablaP.html.twig' with { 'usuarios': fsc.roles }%}
      {% include 'componentes/modalP.html.twig'%} {% include
      'componentes/modalPaginas.html.twig'%}
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="{{
    asset('Plugins/control_permisos/Assets/DataTables/datatables.js')
  }}"></script>
<script src="{{
    asset('Plugins/control_permisos/Assets/JS/insertarRol.js')
  }}"></script>

<script>
  $(document).ready(function () {
    $("#tableMPaginas").DataTable(); // Inicializa la DataTable
    $("#tablaDRoles").DataTable(); // Inicializa la DataTable
    // Detectar el click en los botones de Accesos
    $(document).on("click", ".btn-primary", function () {
      // Obtener el valor de codrole del botón clicado
      var codrole = $(this).closest("tr").find("th:eq(1)").text();
      // Asegurarse de que se recoge un valor de codrole
      if (!codrole) {
        Swal.fire(
          "Error",
          "No se ha podido obtener el valor de codrole",
          "error"
        );
        return;
      }
      var baseUrl = window.location.origin;
      // toma la url para la petición AJAX
      var url = baseUrl + "/sistema2/SelectUser_rol";
      // Realizar petición GET a la API
      $.get(url, { codrole: codrole })
        .done(function (data) {
          // Parsear la respuesta a JSON
          var response = JSON.parse(data);

          // Verificar si la respuesta contiene un error
          if (response.error) {
            // Mostrar mensaje de error
            Swal.fire("Error", response.error, "error");
            return; // Salimos para no ejecutar el código que sigue
          }
          $("#modalPagina").modal("show");
          // Si no hay errores logueamos la respuesta en la consola
          console.log(response);

          // Recorrer la respuesta
          for (var i = 0; i < response.length; i++) {
            // Recorrer cada fila de la tabla
            $("#tableMPaginas tbody tr").each(function () {
              // Si el nombre en la fila de la tabla concuerda con el pagename de la respuesta
              if ($(this).find("td:eq(7)").text() == response[i].pagename) {
                // Puedes hacer lo que necesites aquí, como activar los checkboxs según los permisos en la respuesta
                $(this)
                  .find("td:eq(1) input")
                  .prop("checked", response[i].allowdelete);
                // y así sucesivamente para los otros checkboxs
              }
            });
          }
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          console.error(
            "Error al obtener datos: ",
            textStatus,
            ", Detalles: ",
            errorThrown
          );
          console.error("Respuesta: ", jqXHR.responseText);
          // Mostrar mensaje de error
          Swal.fire(
            "Error",
            "Hubo un problema con la petición: " + textStatus,
            "error"
          );
        });
    });
    $(document).on("click", ".access-button", function () {
      var codrole = $(this).attr("data-role"); // Captura el codrole del botón
      Swal.fire({
        title: "¿Estás seguro?",
        text: "¿Seguro que quieres eliminar este permiso?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Sí, bórralo!",
      }).then((result) => {
        if (result.isConfirmed) {
          var baseUrl = window.location.origin;
          // toma la url para la petición AJAX
          const url = baseUrl + "/sistema2/DeleteRole";
          $.ajax({
            url: url,
            type: "POST",
            data: { id: codrole },
            success: function (response) {
              console.log(response);
              if (response.status == "success") {
                Swal.fire("¡Eliminado!", response.message, "success");
                window.location.reload(); // Recarga la página después del OK
              } else if (response.status == "error") {
                Swal.fire("Error", response.message, "error");
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              Swal.fire(
                "Error",
                "Error al procesar la petición: " +
                  jqXHR.status +
                  " - " +
                  jqXHR.responseText,
                "error"
              );
              //console.log(textStatus, errorThrown);
            },
          });
        }
      });
    });
  });
  $("#formularioRoles").on("submit", function (e) {
    e.preventDefault();
    insertRol();
  });

  // Llamar a la función limpiarModal al cerrar el modal usando jQuery (Bootstrap)
  $("#modalRoles").on("hidden.bs.modal", function (e) {
    limpiarModal();
  });
  function limpiarModal() {
    // Obtener referencia a los campos del formulario dentro del modal
    let codigoRolInput = document.getElementById("codrole");
    let descripcionInput = document.getElementById("descripcion");

    // Limpiar los valores de los campos del formulario
    codigoRolInput.value = "";
    descripcionInput.value = "";
  }
</script>
{% endblock %}
